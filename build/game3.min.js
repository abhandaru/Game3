(function(e){var t=e.Game3={};t.webgl=function(){try{return!!e.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(t){return false}}();t.createRenderer=function(e,n){if(t.webgl){var i=new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});i.setClearColor(16777215,1)}else{i=new THREE.CanvasRenderer}i.setSize(e,n);return i};t.createScene=function(e){var t=new THREE.Scene;t.add(e);e.lookAt(t.position);return t};t.createCamera=function(e){e=e||{};var t=e.viewAngle||60;var n=e.aspect||1;var i=e.near||.1;var s=e.far||1e4;var r=e.position||new THREE.Vector3(500,500,500);var a=new THREE.PerspectiveCamera(t,n,i,s);a.position=r;return a};t.renderLoop=function(t,n){var i=Date.now();var s=function(){e.requestAnimationFrame(s);var r=Date.now()-i;i=Date.now();n.apply(t,[r])};s()}})(window);(function(e){var t=false;var n=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;e.Class=function(){};e.Class.extend=function(e){e=e===undefined?{}:e;var i=this.prototype;t=true;var s=new this;t=false;for(var r in e){s[r]=typeof e[r]=="function"&&typeof i[r]=="function"&&n.test(e[r])?function(e,t){return function(){var n=this._super;this._super=i[e];var s=t.apply(this,arguments);this._super=n;return s}}(r,e[r]):e[r]}function a(){if(!t){if(this.before_init)this.before_init.apply(this,arguments);if(this.init)this.init.apply(this,arguments);if(this.after_init)this.after_init.apply(this,arguments)}}a.prototype=s;a.prototype.constructor=a;a.extend=arguments.callee;return a}})(Game3);Game3.Collision=Game3.Class.extend({init:function(e){this.set(e)},set:function(e){e=e||{};this.point=e.point||this.point||null;this.face=e.face||this.face||null;this.mesh=e.mesh||this.mesh||null;this.other=e.other||this.other||null;this._normal=e.normal||this._normal||null;this._correction=e.correction||this._correction||null},normal:function(){return this._normal||this.face&&this.face.normal||null},correction:function(){return this._correction||new THREE.Vector3(0,0,0)}});Game3.COLLISIONS_GENERAL=1;Game3.COLLISIONS_SPHERES=2;Game3.Collisions=Game3.Class.extend({init:function(e,t){this.models=e||[];t=t!==undefined?t:Game3.COLLISIONS_GENERAL;switch(t){case Game3.COLLISIONS_GENERAL:this.checkFn=this._checkGeneral;break;case Game3.COLLISIONS_SPHERES:this.checkFn=this._checkSphere;break;default:this.checkFn=this._checkGeneral}},track:function(e){this.models.push(e)},check:function(){for(var e=0;e<this.models.length-1;e++){for(var t=e+1;t<this.models.length;t++){var n=this.models[e];var i=this.models[t];var s=n.mesh();var r=i.mesh();var a=this.checkFn(s,r);var o=this.checkFn(r,s);if(a&&o){this._sendCollision(n,a);this._sendCollision(i,o)}}}},_checkGeneral:function(e,t){var n=null;var i=10;e.geometry.vertices.some(function(s){var r=s.clone().applyProjection(e.matrix);var a=r.sub(e.position);var o=a.length();var l=new THREE.Raycaster(e.position,a.clone().normalize(),0,o+i);var h=l.intersectObject(t);if(h.length>0&&h[0].distance<o){n=this._getCollision(a,h[0]);return true}},this);return n},_checkSphere:function(e,t){var n=e.geometry.radius;var i=t.geometry.radius;var s=t.position.clone().sub(e.position);var r=s.length()-(n+i);if(r<0){var a=s.normalize();var o=a.clone().multiplyScalar(n).add(e.position);var l=a.clone().negate();var h=a.clone().multiplyScalar(r/2);return new Game3.Collision({point:o,face:null,normal:l,correction:h,mesh:t,other:t.Game3Model})}return null},_sendCollision:function(e,t){var n=e.collision;if(n&&typeof n=="function"){n.apply(e,[t]);return true}return false},_getCollision:function(e,t){var n=t.distance-e.length();var i=e.clone().normalize().multiplyScalar(n/2);return new Game3.Collision({point:t.point,face:t.face,mesh:t.object,other:t.object.Game3Model,correction:i})}});Game3.Model=Game3.Class.extend({before_init:function(e){this._parent=null;this._mesh=null;this._hitbox=null;this.game=e;this.interactive=false},init:function(e){},add:function(e){if(e instanceof Game3.Model)e.parent(this);return this.game.add(e)},mesh:function(e){if(e===undefined)return this._mesh;this._mesh=e;this._mesh.Game3Model=this},hitbox:function(e){if(e===undefined)return this._hitbox;this._hitbox=e;this._hitbox.Game3Model=this},parent:function(e){if(e===undefined)return this._parent;this._parent=e}});Game3.Light=Game3.Class.extend({init:function(e,t){if(e===undefined)e=16777215;if(t===undefined)t=new THREE.Vector3(0,0,0);var n=new THREE.PointLight(e);n.position=t;this.light(n)},light:function(e){if(e===undefined)return this._light;this._light=e}});Game3.Event=Game3.Class.extend({init:function(e){this.set(e)},set:function(e){e=e||{};this.model=e.model||this.model||null;this.native=e.native||this.native||null;this.distance=e.distance||this.distance||null;this.delta2D=e.delta2D||this.delta2D||null;this.point2D=e.point2D||this.point2D||null;this.point3D=e.point3D||this.point3D||null;this.face=e.face||this.face||null;this.mesh=e.mesh||this.mesh||null},scrollDelta:function(){var e=this.native.wheelDeltaX!==undefined;var t=new THREE.Vector2(this.native.wheelDeltaX,this.native.wheelDeltaY);return e&&t||null}});Game3.EVENTS_LEFT_CLICK="click";Game3.EVENTS_RIGHT_CLICK="rightclick";Game3.EVENTS_MOUSEMOVE="mousemove";Game3.EVENTS_MOUSEDOWN="mousedown";Game3.EVENTS_MOUSEUP="mouseup";Game3.EVENTS_MOUSEOVER="mouseover";Game3.EVENTS_MOUSEOUT="mouseout";Game3.EVENTS_MOUSEDRAG="mousedrag";Game3.EVENTS_MOUSEDROP="mousedrop";Game3.EVENTS_MOUSESCROLL="scroll";Game3.Events=Game3.Class.extend({init:function(e){this.game=e;this.objects=[];this.projector=new THREE.Projector;this.isMouseDown=false;this.lastMousePosition=new THREE.Vector2(0,0);this.lastOver=null;this.lastClick=null;this.lastDrag=null;this.bind(e.canvas)},track:function(e){this.objects.push(e)},bind:function(e){var t=this;var n=["click","mousedown","mouseup","mousemove","wheel","contextmenu"];n.forEach(function(n){var i=t.wrapper(t[n]);e.addEventListener(n,i)})},wrapper:function(e){var t=this;return function(n){var i=new THREE.Vector2(n.layerX,n.layerY);var s=new Game3.Event({"native":n,delta2D:i.clone().sub(t.lastMousePosition),point2D:i});var r=t.getTargets(i.x,i.y);if(r.length){var a=r[0];s.set({distance:a.distance,point3D:a.point,face:a.face,mesh:a.object,model:a.object.Game3Model})}else{s.set({model:t.game})}var o=e.apply(t,[s]);t.checkFocus(s.model,i);t.lastMousePosition.set(i.x,i.y);if(o)n.preventDefault();return o}},click:function(e){this.lastClick=e.model;return this.resolveEvent(e.model,Game3.EVENTS_LEFT_CLICK,e)},mousedown:function(e){this.lastClick=e.model;this.isMouseDown=true;return this.resolveEvent(e.model,Game3.EVENTS_MOUSEDOWN,e)},mouseup:function(e){this.isMouseDown=false;var t=this.resolveEvent(e.model,Game3.EVENTS_MOUSEUP,e);if(this.lastDrag){this.resolveEvent(this.lastDrag,Game3.EVENTS_MOUSEDROP,e);this.lastDrag=null}return t},mousemove:function(e){var t=e.model;var n=this.resolveEvent(t,Game3.EVENTS_MOUSEMOVE,e);if(this.lastOver!==t){this.resolveEvent(t,Game3.EVENTS_MOUSEOVER,e)}if(this.isMouseDown&&this.lastClick===t){this.lastDrag=t;this.resolveEvent(t,Game3.EVENTS_MOUSEDRAG,e)}else if(this.isMouseDown&&this.lastDrag){this.resolveEvent(this.lastDrag,Game3.EVENTS_MOUSEDRAG,e)}return n},wheel:function(e){var t=e.model;return this.resolveEvent(t,Game3.EVENTS_MOUSESCROLL,e)},contextmenu:function(e){var t=e.model;return this.resolveEvent(t,Game3.EVENTS_RIGHT_CLICK,e)},getTargets:function(e,t){var n=this.game.camera;var i=new THREE.Vector3(e/this.game.width*2-1,-(t/this.game.height)*2+1,.5);this.projector.unprojectVector(i,n);var s=new THREE.Raycaster(n.position,i.sub(n.position).normalize());var r=s.intersectObjects(this.objects);return r},checkFocus:function(e,t){var n=this.lastOver;var i=false;if(n&&(!e||n!==e)){var s=new Game3.Event({point2D:t.clone(),model:n});i=this.resolveEvent(n,Game3.EVENTS_MOUSEOUT,s)}this.lastOver=e;return i},resolveEvent:function(e,t,n){while(e){handled=this.sendEvent(e,t,n);if(handled)return handled;e=e.parent()}return false},sendEvent:function(e,t,n){var i=e[t];if(e&&i&&typeof i=="function"){return i.apply(e,[n])!==false}return false}});Game3.Game=Game3.Class.extend({before_init:function(e){this.el=e;var t=e.offsetWidth;var n=e.offsetHeight;this.bindResize=true;this.width=t;this.height=n;this.camera=Game3.createCamera({aspect:t/n});this.scene=Game3.createScene(this.camera);this.renderer=Game3.createRenderer(t,n);this.canvas=this.renderer.domElement;this.el.appendChild(this.canvas);this.events=new Game3.Events(this)},init:function(e){},after_init:function(e){var t=this;if(this.bindResize){window.addEventListener("resize",function(){return t.resize()})}Game3.renderLoop(this,this.render)},add:function(e){if(!e)return false;if(e instanceof Game3.Light){var t=e;this.scene.add(t.light());return true}else if(e instanceof Game3.Model){var n=e;var i=n.mesh();var s=n.hitbox();var r=n.interactive;s=s||i;if(i)this.scene.add(i);if(s&&r)this.events.track(s);if(i||s&&r){n.parent(this);return true}else return false}else if(e instanceof THREE.Light||e instanceof THREE.Object3D){this.scene.add(e);return true}return false},parent:function(){return null},resize:function(){var e=this.width=this.el.offsetWidth;var t=this.height=this.el.offsetHeight;this.renderer.setSize(e,t);this.camera.aspect=e/t;this.camera.updateProjectionMatrix()},timerfired:function(e){},render:function(e){this.timerfired(e);this.renderer.render(this.scene,this.camera)}});