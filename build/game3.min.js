(function(e){var t=e.Game3={};t.webgl=function(){try{return!!e.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(t){return false}}();t.createRenderer=function(e,i){if(t.webgl){var n=new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});n.setClearColor(16777215,1)}else{n=new THREE.CanvasRenderer}n.setSize(e,i);return n};t.createScene=function(e){var t=new THREE.Scene;t.add(e);e.lookAt(t.position);return t};t.createCamera=function(e){e=e||{};var t=e.viewAngle||60;var i=e.aspect||1;var n=e.near||.1;var s=e.far||1e4;var r=e.position||new THREE.Vector3(500,500,500);var a=new THREE.PerspectiveCamera(t,i,n,s);a.position=r;return a};t.renderLoop=function(t,i){var n=Date.now();var s=function(){e.requestAnimationFrame(s);var r=Date.now();var a=r-n;n=r;i.apply(t,[a])};s()}})(window);(function(e){var t=false;var i=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;e.Class=function(){};e.Class.extend=function(e){e=e===undefined?{}:e;var n=this.prototype;t=true;var s=new this;t=false;for(var r in e){s[r]=typeof e[r]=="function"&&typeof n[r]=="function"&&i.test(e[r])?function(e,t){return function(){var i=this._super;this._super=n[e];var s=t.apply(this,arguments);this._super=i;return s}}(r,e[r]):e[r]}function a(){if(!t){if(this.before_init)this.before_init.apply(this,arguments);if(this.init)this.init.apply(this,arguments);if(this.after_init)this.after_init.apply(this,arguments)}}a.prototype=s;a.prototype.constructor=a;a.extend=arguments.callee;return a}})(Game3);Game3.Collision=Game3.Class.extend({init:function(e){this.set(e)},set:function(e){e=e||{};this.point=e.point||this.point||null;this.face=e.face||this.face||null;this.mesh=e.mesh||this.mesh||null;this.other=e.other||this.other||null;this._normal=e.normal||this._normal||null;this._correction=e.correction||this._correction||null},normal:function(){return this._normal||this.face&&this.face.normal||null},correction:function(){return this._correction||new THREE.Vector3(0,0,0)}});Game3.COLLISIONS_GENERAL=1;Game3.COLLISIONS_SPHERES=2;Game3.Collisions=Game3.Class.extend({init:function(e,t){this.models=e||[];t=t!==undefined?t:Game3.COLLISIONS_GENERAL;switch(t){case Game3.COLLISIONS_GENERAL:this.checkFn=this._checkGeneral;break;case Game3.COLLISIONS_SPHERES:this.checkFn=this._checkSphere;break;default:this.checkFn=this._checkGeneral}},track:function(e){this.models.push(e)},check:function(){for(var e=0;e<this.models.length-1;e++){for(var t=e+1;t<this.models.length;t++){var i=this.models[e];var n=this.models[t];var s=i.mesh();var r=n.mesh();var a=this.checkFn(s,r);var o=this.checkFn(r,s);if(a&&o){this._sendCollision(i,a);this._sendCollision(n,o)}}}},_checkGeneral:function(e,t){var i=null;var n=10;e.geometry.vertices.some(function(s){var r=s.clone().applyProjection(e.matrix);var a=r.sub(e.position);var o=a.length();var h=new THREE.Raycaster(e.position,a.clone().normalize(),0,o+n);var l=h.intersectObject(t);if(l.length>0&&l[0].distance<o){i=this._getCollision(a,l[0]);return true}},this);return i},_checkSphere:function(e,t){var i=e.geometry.radius;var n=t.geometry.radius;var s=t.position.clone().sub(e.position);var r=s.length()-(i+n);if(r<0){var a=s.normalize();var o=a.clone().multiplyScalar(i).add(e.position);var h=a.clone().negate();var l=a.clone().multiplyScalar(r/2);return new Game3.Collision({point:o,face:null,normal:h,correction:l,mesh:t,other:t.Game3Model})}return null},_sendCollision:function(e,t){var i=e.collision;if(i&&typeof i=="function"){i.apply(e,[t]);return true}return false},_getCollision:function(e,t){var i=t.distance-e.length();var n=e.clone().normalize().multiplyScalar(i/2);return new Game3.Collision({point:t.point,face:t.face,mesh:t.object,other:t.object.Game3Model,correction:n})}});Game3.Model=Game3.Class.extend({before_init:function(e){this.__parent=null;this.__children=[];this.__visible=false;this.__mesh=null;this.__hitbox=null;this.game=e;this.interactive=false},init:function(e){},add:function(e){if(e instanceof Game3.Model){e.parent(this)}this.__children.push(e);return this.__visible?this.game.add(e):true},mesh:function(e){if(e===undefined)return this.__mesh;this.__mesh=e;this.__mesh.Game3Model=this},hitbox:function(e){if(e===undefined)return this.__hitbox;this.__hitbox=e;this.__hitbox.Game3Model=this},parent:function(e){if(e===undefined)return this.__parent;this.__parent=e},__show:function(){this.__visible=true;this.__children.forEach(function(e){this.game.add(e)},this)}});Game3.Light=Game3.Class.extend({init:function(e,t){if(e===undefined)e=16777215;if(t===undefined)t=new THREE.Vector3(0,0,0);var i=new THREE.PointLight(e);i.position=t;this.light(i)},light:function(e){if(e===undefined)return this._light;this._light=e}});Game3.Event=Game3.Class.extend({init:function(e){this.set(e)},set:function(e){e=e||{};this.model=e.model||this.model||null;this.native=e.native||this.native||null;this.distance=e.distance||this.distance||null;this.delta2D=e.delta2D||this.delta2D||null;this.point2D=e.point2D||this.point2D||null;this.point3D=e.point3D||this.point3D||null;this.face=e.face||this.face||null;this.mesh=e.mesh||this.mesh||null},scrollDelta:function(){var e=this.native.wheelDeltaX!==undefined;var t=new THREE.Vector2(this.native.wheelDeltaX,this.native.wheelDeltaY);return e&&t||null}});Game3.EVENTS_LEFT_CLICK="click";Game3.EVENTS_RIGHT_CLICK="rightclick";Game3.EVENTS_MOUSEMOVE="mousemove";Game3.EVENTS_MOUSEDOWN="mousedown";Game3.EVENTS_MOUSEUP="mouseup";Game3.EVENTS_MOUSEOVER="mouseover";Game3.EVENTS_MOUSEOUT="mouseout";Game3.EVENTS_MOUSEDRAG="mousedrag";Game3.EVENTS_MOUSEDROP="mousedrop";Game3.EVENTS_MOUSESCROLL="scroll";Game3.Events=Game3.Class.extend({init:function(e){this.game=e;this.objects=[];this.projector=new THREE.Projector;this.isMouseDown=false;this.lastMousePosition=new THREE.Vector2(0,0);this.lastOver=null;this.lastClick=null;this.lastDrag=null;this.bind(e.canvas)},track:function(e){this.objects.push(e)},bind:function(e){var t=this;var i=["click","mousedown","mouseup","mousemove","wheel","contextmenu"];i.forEach(function(i){var n=t.wrapper(t[i]);e.addEventListener(i,n)})},wrapper:function(e){var t=this;return function(i){var n=new THREE.Vector2(i.layerX,i.layerY);var s=new Game3.Event({"native":i,delta2D:n.clone().sub(t.lastMousePosition),point2D:n});var r=t.getTargets(n.x,n.y);if(r.length){var a=r[0];s.set({distance:a.distance,point3D:a.point,face:a.face,mesh:a.object,model:a.object.Game3Model})}else{s.set({model:t.game})}var o=e.apply(t,[s]);t.checkFocus(s.model,n);t.lastMousePosition.set(n.x,n.y);if(o)i.preventDefault();return o}},click:function(e){this.lastClick=e.model;return this.resolveEvent(e.model,Game3.EVENTS_LEFT_CLICK,e)},mousedown:function(e){this.lastClick=e.model;this.isMouseDown=true;return this.resolveEvent(e.model,Game3.EVENTS_MOUSEDOWN,e)},mouseup:function(e){this.isMouseDown=false;var t=this.resolveEvent(e.model,Game3.EVENTS_MOUSEUP,e);if(this.lastDrag){this.resolveEvent(this.lastDrag,Game3.EVENTS_MOUSEDROP,e);this.lastDrag=null}return t},mousemove:function(e){var t=e.model;var i=this.resolveEvent(t,Game3.EVENTS_MOUSEMOVE,e);if(this.lastOver!==t){this.resolveEvent(t,Game3.EVENTS_MOUSEOVER,e)}if(this.isMouseDown&&this.lastClick===t){this.lastDrag=t;this.resolveEvent(t,Game3.EVENTS_MOUSEDRAG,e)}else if(this.isMouseDown&&this.lastDrag){this.resolveEvent(this.lastDrag,Game3.EVENTS_MOUSEDRAG,e)}return i},wheel:function(e){var t=e.model;return this.resolveEvent(t,Game3.EVENTS_MOUSESCROLL,e)},contextmenu:function(e){var t=e.model;return this.resolveEvent(t,Game3.EVENTS_RIGHT_CLICK,e)},getTargets:function(e,t){var i=this.game.camera;var n=new THREE.Vector3(e/this.game.width*2-1,-(t/this.game.height)*2+1,.5);this.projector.unprojectVector(n,i);var s=new THREE.Raycaster(i.position,n.sub(i.position).normalize());var r=s.intersectObjects(this.objects);return r},checkFocus:function(e,t){var i=this.lastOver;var n=false;if(i&&(!e||i!==e)){var s=new Game3.Event({point2D:t.clone(),model:i});n=this.resolveEvent(i,Game3.EVENTS_MOUSEOUT,s)}this.lastOver=e;return n},resolveEvent:function(e,t,i){while(e){handled=this.sendEvent(e,t,i);if(handled)return handled;e=e.parent()}return false},sendEvent:function(e,t,i){var n=e[t];if(e&&n&&typeof n=="function"){return n.apply(e,[i])!==false}return false}});Game3.Game=Game3.Class.extend({before_init:function(e){this.el=e;var t=e.offsetWidth;var i=e.offsetHeight;this.bindResize=true;this.width=t;this.height=i;this.camera=Game3.createCamera({aspect:t/i});this.scene=Game3.createScene(this.camera);this.renderer=Game3.createRenderer(t,i);this.canvas=this.renderer.domElement;this.el.appendChild(this.canvas);this.events=new Game3.Events(this)},init:function(e){},after_init:function(e){var t=this;if(this.bindResize){window.addEventListener("resize",function(){return t.resize()})}Game3.renderLoop(this,this.__render)},add:function(e){if(!e)return false;if(e instanceof Game3.Light){var t=e;this.scene.add(t.light());return true}else if(e instanceof Game3.Model){var i=e;var n=i.mesh();var s=i.hitbox()||n;var r=i.interactive;if(n)this.scene.add(n);if(s&&r)this.events.track(s);if(!i.parent())i.parent(this);i.__show();return true}else if(e instanceof THREE.Light||e instanceof THREE.Object3D){this.scene.add(e);return true}return false},parent:function(){return null},resize:function(){var e=this.width=this.el.offsetWidth;var t=this.height=this.el.offsetHeight;this.renderer.setSize(e,t);this.camera.aspect=e/t;this.camera.updateProjectionMatrix()},update:function(e){},__render:function(e){this.update(e);this.renderer.render(this.scene,this.camera)}});