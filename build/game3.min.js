(function(window){var Game3=window.Game3={};Game3.webgl=function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return false}}();Game3.createRenderer=function(width,height){if(Game3.webgl){var renderer=new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});renderer.setClearColor(16777215,1)}else{renderer=new THREE.CanvasRenderer}renderer.setSize(width,height);return renderer};Game3.createScene=function(camera){var scene=new THREE.Scene;scene.add(camera);camera.lookAt(scene.position);return scene};Game3.createCamera=function(options){options=options||{};var viewAngle=options.viewAngle||60;var aspect=options.aspect||1;var near=options.near||.1;var far=options.far||1e4;var position=options.position||new THREE.Vector3(500,500,500);var camera=new THREE.PerspectiveCamera(viewAngle,aspect,near,far);camera.position=position;return camera};Game3.renderLoop=function(caller,renderFn){var lastUpdate=Date.now();var render=function(){window.requestAnimationFrame(render);var dt=Date.now()-lastUpdate;lastUpdate=Date.now();renderFn.apply(caller,[dt])};render()}})(window);(function(Game3){var initializing=false;var fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Game3.Class=function(){};Game3.Class.extend=function(prop){prop=prop===undefined?{}:prop;var _super=this.prototype;initializing=true;var prototype=new this;initializing=false;for(var name in prop){prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"&&fnTest.test(prop[name])?function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret}}(name,prop[name]):prop[name]}function Class(){if(!initializing){if(this.before_init)this.before_init.apply(this,arguments);if(this.init)this.init.apply(this,arguments);if(this.after_init)this.after_init.apply(this,arguments)}}Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=arguments.callee;return Class}})(Game3);Game3.Collision=Game3.Class.extend({init:function(params){this.set(params)},set:function(params){params=params||{};this.point=params.point||this.point||null;this.face=params.face||this.face||null;this.mesh=params.mesh||this.mesh||null;this.other=params.other||this.other||null;this._normal=params.normal||this._normal||null;this._correction=params.correction||this._correction||null},normal:function(){return this._normal||this.face&&this.face.normal||null},correction:function(){return this._correction||new THREE.Vector3(0,0,0)}});Game3.COLLISIONS_GENERAL=1;Game3.COLLISIONS_SPHERES=2;Game3.Collisions=Game3.Class.extend({init:function(models,type){this.models=models||[];type=type!==undefined?type:Game3.COLLISIONS_GENERAL;switch(type){case Game3.COLLISIONS_GENERAL:this.checkFn=this._checkGeneral;break;case Game3.COLLISIONS_SPHERES:this.checkFn=this._checkSphere;break;default:this.checkFn=this._checkGeneral}},track:function(model){this.models.push(model)},check:function(){for(var i=0;i<this.models.length-1;i++){for(var j=i+1;j<this.models.length;j++){var modelA=this.models[i];var modelB=this.models[j];var meshA=modelA.mesh();var meshB=modelB.mesh();var collisionA=this.checkFn(meshA,meshB);var collisionB=this.checkFn(meshB,meshA);if(collisionA&&collisionB){this._sendCollision(modelA,collisionA);this._sendCollision(modelB,collisionB)}}}},_checkGeneral:function(meshA,meshB){var collision=null;var err=10;meshA.geometry.vertices.some(function(vertex){var globalVertex=vertex.clone().applyProjection(meshA.matrix);var direction=globalVertex.sub(meshA.position);var dist=direction.length();var ray=new THREE.Raycaster(meshA.position,direction.clone().normalize(),0,dist+err);var intersects=ray.intersectObject(meshB);if(intersects.length>0&&intersects[0].distance<dist){collision=this._getCollision(direction,intersects[0]);return true}},this);return collision},_checkSphere:function(sphereA,sphereB){var radiusA=sphereA.geometry.radius;var radiusB=sphereB.geometry.radius;var distance=sphereB.position.clone().sub(sphereA.position);var difference=distance.length()-(radiusA+radiusB);if(difference<0){var unit=distance.normalize();var point=unit.clone().multiplyScalar(radiusA).add(sphereA.position);var normal=unit.clone().negate();var correction=unit.clone().multiplyScalar(difference/2);return new Game3.Collision({point:point,face:null,normal:normal,correction:correction,mesh:sphereB,other:sphereB.Game3Model})}return null},_sendCollision:function(model,collision){var handler=model.collision;if(handler&&typeof handler=="function"){handler.apply(model,[collision]);return true}return false},_getCollision:function(direction,intersection){var difference=intersection.distance-direction.length();var correction=direction.clone().normalize().multiplyScalar(difference/2);return new Game3.Collision({point:intersection.point,face:intersection.face,mesh:intersection.object,other:intersection.object.Game3Model,correction:correction})}});Game3.Model=Game3.Class.extend({before_init:function(game){this.game=game;this.interactive=false;this._mesh=null;this._hitbox=null},init:function(game){},mesh:function(mesh){if(mesh===undefined)return this._mesh;this._mesh=mesh;this._mesh.Game3Model=this},hitbox:function(hitbox){if(hitbox===undefined)return this._hitbox;this._hitbox=hitbox;this._hitbox.Game3Model=this},show:function(interactive){if(interactive===undefined)interactive=false;this.interactive=interactive;if(interactive)this.game.addDynamic(this._mesh,this._hitbox);else this.game.addStatic(this._mesh)},hide:function(){}});Game3.Light=Game3.Class.extend({init:function(game,color,position){this.game=game;if(color===undefined)color=16777215;if(position===undefined)position=new THREE.Vector3(0,0,0);var light=new THREE.PointLight(color);light.position=position;this.setLight(light)},setLight:function(light){if(light===undefined)return light;this.light=light},show:function(){this.game.addLight(this.light)}});Game3.Event=Game3.Class.extend({init:function(params){this.set(params)},set:function(params){params=params||{};this.model=params.model||this.model||null;this.native=params.native||this.native||null;this.distance=params.distance||this.distance||null;this.delta2D=params.delta2D||this.delta2D||null;this.point2D=params.point2D||this.point2D||null;this.point3D=params.point3D||this.point3D||null;this.face=params.face||this.face||null;this.mesh=params.mesh||this.mesh||null},scrollDelta:function(){var isWheel=this.native.wheelDeltaX!==undefined;var delta=new THREE.Vector2(this.native.wheelDeltaX,this.native.wheelDeltaY);return isWheel&&delta||null}});Game3.EVENTS_LEFT_CLICK="click";Game3.EVENTS_RIGHT_CLICK="rightclick";Game3.EVENTS_MOUSEMOVE="mousemove";Game3.EVENTS_MOUSEDOWN="mousedown";Game3.EVENTS_MOUSEUP="mouseup";Game3.EVENTS_MOUSEOVER="mouseover";Game3.EVENTS_MOUSEOUT="mouseout";Game3.EVENTS_MOUSEDRAG="mousedrag";Game3.EVENTS_MOUSEDROP="mousedrop";Game3.EVENTS_MOUSESCROLL="scroll";Game3.Events=Game3.Class.extend({init:function(game){this.game=game;this.objects=[];this.projector=new THREE.Projector;this.isMouseDown=false;this.lastMousePosition=new THREE.Vector2(0,0);this.lastOver=null;this.lastClick=null;this.lastDrag=null;this.bind(game.canvas)},track:function(object){this.objects.push(object)},bind:function(container){var _this=this;var types=["click","mousedown","mouseup","mousemove","wheel","contextmenu"];types.forEach(function(type){var handler=_this.wrapper(_this[type]);container.addEventListener(type,handler)})},wrapper:function(handler){var _this=this;return function(event){var coords=new THREE.Vector2(event.layerX,event.layerY);var eventG3=new Game3.Event({"native":event,delta2D:coords.clone().sub(_this.lastMousePosition),point2D:coords});var targets=_this.getTargets(coords.x,coords.y);if(targets.length){var target=targets[0];eventG3.set({distance:target.distance,point3D:target.point,face:target.face,mesh:target.object,model:target.object.Game3Model})}else{eventG3.set({model:_this.game})}var ret=handler.apply(_this,[eventG3]);_this.checkFocus(eventG3.model,coords);_this.lastMousePosition.set(coords.x,coords.y);if(ret)event.preventDefault();return ret}},click:function(event){this.lastClick=event.model;return this.resolveEvent(event.model,Game3.EVENTS_LEFT_CLICK,event)},mousedown:function(event){this.lastClick=event.model;this.isMouseDown=true;return this.resolveEvent(event.model,Game3.EVENTS_MOUSEDOWN,event)},mouseup:function(event){this.isMouseDown=false;var ret=this.resolveEvent(event.model,Game3.EVENTS_MOUSEUP,event);if(this.lastDrag){this.resolveEvent(this.lastDrag,Game3.EVENTS_MOUSEDROP,event);this.lastDrag=null}return ret},mousemove:function(event){var target=event.model;var ret=this.resolveEvent(target,Game3.EVENTS_MOUSEMOVE,event);if(this.lastOver!==target){this.resolveEvent(target,Game3.EVENTS_MOUSEOVER,event)}if(this.isMouseDown&&this.lastClick===target){this.lastDrag=target;this.resolveEvent(target,Game3.EVENTS_MOUSEDRAG,event)}else if(this.isMouseDown&&this.lastDrag){this.resolveEvent(this.lastDrag,Game3.EVENTS_MOUSEDRAG,event)}return ret},wheel:function(event){var target=event.model;return this.resolveEvent(target,Game3.EVENTS_MOUSESCROLL,event)},contextmenu:function(event){var target=event.model;return this.resolveEvent(target,Game3.EVENTS_RIGHT_CLICK,event)},getTargets:function(x,y){var camera=this.game.camera;var vector=new THREE.Vector3(x/this.game.width*2-1,-(y/this.game.height)*2+1,.5);this.projector.unprojectVector(vector,camera);var raycaster=new THREE.Raycaster(camera.position,vector.sub(camera.position).normalize());var intersects=raycaster.intersectObjects(this.objects);return intersects},checkFocus:function(current,coords){var focus=this.lastOver;var ret=false;if(focus&&(!current||focus!==current)){var event=new Game3.Event({point2D:coords.clone(),model:focus});ret=this.resolveEvent(focus,Game3.EVENTS_MOUSEOUT,event)}this.lastOver=current;return ret},resolveEvent:function(model,handler,event){if(this.sendEvent(model,handler,event))return true;return this.sendEvent(this.game,handler,event)},sendEvent:function(model,handler,event){var handlerFn=model[handler];if(model&&handlerFn&&typeof handlerFn=="function"){return handlerFn.apply(model,[event])!==false}return false}});Game3.Game=Game3.Class.extend({before_init:function(el){this.el=el;var width=el.offsetWidth;var height=el.offsetHeight;this.bindResize=true;this.width=width;this.height=height;this.camera=Game3.createCamera({aspect:width/height});this.scene=Game3.createScene(this.camera);this.renderer=Game3.createRenderer(width,height);this.canvas=this.renderer.domElement;this.el.appendChild(this.canvas);this.events=new Game3.Events(this)},init:function(el){},after_init:function(el){var _this=this;if(this.bindResize){window.addEventListener("resize",function(){return _this.resize()})}Game3.renderLoop(this,this.render)},addStatic:function(object){this.scene.add(object)},addDynamic:function(object,hitbox){if(hitbox===undefined)hitbox=object;this.events.track(hitbox);this.scene.add(object)},addLight:function(light){this.scene.add(light)},resize:function(){var width=this.width=this.el.offsetWidth;var height=this.height=this.el.offsetHeight;this.renderer.setSize(width,height);this.camera.aspect=width/height;this.camera.updateProjectionMatrix()},timerfired:function(dt){},render:function(dt){this.timerfired(dt);this.renderer.render(this.scene,this.camera)}});