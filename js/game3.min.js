(function(window){var G3=window.G3={};G3.webgl=function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(e){return false}}();G3.createRenderer=function(width,height){if(G3.webgl){var renderer=new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});renderer.setClearColor(16777215,1)}else{renderer=new THREE.CanvasRenderer}renderer.setSize(width,height);return renderer};G3.createScene=function(camera){var scene=new THREE.Scene;scene.add(camera);camera.lookAt(scene.position);return scene};G3.createCamera=function(options){options=options||{};var viewAngle=options.viewAngle||60;var aspect=options.aspect||1;var near=options.near||.1;var far=options.far||1e4;var position=options.position||new THREE.Vector3(500,500,500);var camera=new THREE.PerspectiveCamera(viewAngle,aspect,near,far);camera.position=position;return camera};G3.renderLoop=function(caller,renderFn){var render=function(){window.requestAnimationFrame(render);renderFn.apply(caller)};render()}})(window);(function(G3){var initializing=false;var fnTest=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;G3.Class=function(){};G3.Class.extend=function(prop){prop=prop===undefined?{}:prop;var _super=this.prototype;initializing=true;var prototype=new this;initializing=false;for(var name in prop){prototype[name]=typeof prop[name]=="function"&&typeof _super[name]=="function"&&fnTest.test(prop[name])?function(name,fn){return function(){var tmp=this._super;this._super=_super[name];var ret=fn.apply(this,arguments);this._super=tmp;return ret}}(name,prop[name]):prop[name]}function Class(){if(!initializing&&this.init)this.init.apply(this,arguments)}Class.prototype=prototype;Class.prototype.constructor=Class;Class.extend=arguments.callee;return Class}})(G3);G3.Model=G3.Class.extend({init:function(game){this.game=game;this.interactive=false},setMesh:function(mesh){this.mesh=mesh;this.mesh.G3Model=this},show:function(interactive){if(interactive===undefined)interactive=false;this.interactive=interactive;if(interactive)this.game.addDynamic(this.mesh);else this.game.addStatic(this.mesh)},hide:function(){}});G3.Light=G3.Class.extend({init:function(game,color,position){this.game=game;if(color===undefined)color=16777215;if(position===undefined)position=new THREE.Vector3(0,0,0);var light=new THREE.PointLight(color);light.position=position;this.setLight(light)},setLight:function(light){if(light===undefined)return light;this.light=light},show:function(){this.game.addLight(this.light)}});G3.Event=G3.Class.extend({init:function(params){this.set(params)},set:function(params){params=params||{};this.distance=params.distance||this.distance||-1;this.delta2D=params.delta2D||this.delta2D||new THREE.Vector2(0,0);this.point2D=params.point2D||this.point2D||new THREE.Vector2(0,0);this.point3D=params.point3D||this.point3D||new THREE.Vector3(0,0,0);this.face=params.face||this.face||null;this.mesh=params.mesh||this.mesh||null;this.model=params.model||this.model||null}});G3.Events=G3.Class.extend({init:function(game){this.game=game;this.objects=[];this.projector=new THREE.Projector;this.isMouseDown=false;this.lastMousePosition=new THREE.Vector2(0,0);this.lastOver=null;this.lastClick=null;this.bind(game.canvas)},track:function(object){this.objects.push(object)},bind:function(container){var that=this;var types=["click","mousedown","mouseup","mousemove"];types.forEach(function(type){var handler=that.wrapper(that[type]);container.addEventListener(type,handler)})},wrapper:function(handler){var that=this;return function(event){var coords=new THREE.Vector2(event.layerX,event.layerY);var eventG3=new G3.Event({delta2D:coords.clone().sub(that.lastMousePosition),point2D:coords.clone()});var targets=that.getTargets(coords.x,coords.y);if(targets.length){var target=targets[0];eventG3.set({distance:target.distance,point3D:target.point,face:target.face,mesh:target.object,model:target.object.G3Model})}else{eventG3.set({model:that.game})}var ret=handler.apply(that,[eventG3]);that.checkFocus(eventG3.model,coords);that.lastMousePosition.set(coords.x,coords.y);event.preventDefault();return ret}},getTargets:function(x,y){var camera=this.game.camera;var vector=new THREE.Vector3(x/this.game.width*2-1,-(y/this.game.height)*2+1,.5);this.projector.unprojectVector(vector,camera);var raycaster=new THREE.Raycaster(camera.position,vector.sub(camera.position).normalize());var intersects=raycaster.intersectObjects(this.objects);return intersects},click:function(event){this.lastClick=event.model;var handler=event.model.click;this.sendEvent(event.model,handler,event)},mousedown:function(event){this.lastClick=event.model;this.isMouseDown=true;var handler=event.model.mousedown;this.sendEvent(event.model,handler,event)},mouseup:function(event){this.isMouseDown=false;var handler=event.model.mouseup;this.sendEvent(event.model,handler,event)},mousemove:function(event){var target=event.model;var handler=target.mousemove;this.sendEvent(target,handler,event);if(this.lastOver!==target){this.sendEvent(target,target.mouseover,event)}if(this.isMouseDown&&this.lastClick===target){this.sendEvent(target,target.mousedrag,event)}},checkFocus:function(current,coords){var focus=this.lastOver;if(focus&&(!current||focus!==current)){var event=new G3.Event({point2D:coords.clone(),model:focus});this.sendEvent(focus,focus.mouseout,event)}this.lastOver=current},sendEvent:function(model,handler,event){if(model&&handler&&typeof handler=="function"){handler.apply(model,[event]);return true}return false}});G3.Game=G3.Class.extend({init:function(el){this.el=el;var width=el.offsetWidth;var height=el.offsetHeight;this.width=width;this.height=height;this.camera=G3.createCamera({aspect:width/height});this.scene=G3.createScene(this.camera);this.renderer=G3.createRenderer(width,height);this.canvas=this.renderer.domElement;this.el.appendChild(this.canvas);this.events=new G3.Events(this);G3.renderLoop(this,this.render)},addStatic:function(object){this.scene.add(object)},addDynamic:function(object){this.events.track(object);this.scene.add(object)},addLight:function(light){this.scene.add(light)},animate:function(){},render:function(){try{this.animate()}catch(e){}this.renderer.render(this.scene,this.camera)}});